<!doctype html>
<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta http-equiv="Content-Type" content="text/html;charset=UTF-8" />
<!-- <base href="../"> -->

<title>Sparqlish</title>
<script  id="sap-ui-bootstrap" 
         src="../openui5/sap-ui-core.js" 
         data-sap-ui-theme="sap_bluecrystal" 
         data-sap-ui-libs="sap.ui.commons"
		 data-sap-ui-libs="sap.ui.unified" 
		 data-sap-ui-libs="sap.ui.table" 
		 data-sap-ui-resourceroots='{
            "sparqlish":"../",
					"sparqlish":"../sparqlish",
			 "lens":"../",
					"lens":"../lens",
			 "Components":"../",
					"Components":"../Components"
        }'		
        data-sap-ui-xx-bindingSyntax="complex" 
        type="text/javascript"></script>
<script type="text/javascript" src="../resources/jquery.rdfquery.core.min-1.0.js"></script>
<script type="text/javascript" src="../sparqlish/sparqlish.js"></script>
<script type="text/javascript" src="../sparqlish/utilities.js"></script>
<script type="text/javascript" src="../sparqlish/control/propertyMenu.js"></script>
<script type="text/javascript" src="../sparqlish/control/includeOptionalIgnore.js"></script>
<script type="text/javascript" src="../sparqlish/control/queryClause.js"></script>
<script type="text/javascript" src="../sparqlish/control/conceptClause.js"></script>
<script type="text/javascript" src="../sparqlish/control/propertyClause.js"></script>
<script type="text/javascript" src="../sparqlish/control/conjunctionPropertyClause.js"></script>
<script type="text/javascript" src="../sparqlish/control/query.js"></script>

<link rel="stylesheet" type="text/css" href="../sparqlish/sparqlish.css">

<script type="text/javascript">
jQuery.sap.log.setLevel(jQuery.sap.log.Level.DEBUG );
//var sUrl = "http://services.odata.org/V2/Northwind/Northwind.svc/" ;
var sUrl = "../proxy/http/services.odata.org/V2/Northwind/Northwind.svc/" ;
//var sUrl = "test-resources/" ;
//Mock OData server
jQuery.sap.require("sap.ui.core.util.MockServer");


var sUri = "test-resources/";
var oMockServer = new sap.ui.core.util.MockServer({
	rootUri : sUri
});
var sMetadataUrl = "../config/test/northwind.v2.metadata.xml";
oMockServer.simulate(sMetadataUrl,{
                'bGenerateMissingMockData' : true
            });
oMockServer.start();

var oDataModel = new sap.ui.model.odata.ODataModel(sUri, true);
var oMetaModel = oDataModel.getMetaModel();
sap.ui.getCore().setModel(oMetaModel, "metaModel");

// TODO this should be part of the control
var oMetaModelEntityContainer = oMetaModel.getODataEntityContainer();
var oEntityContainerModel = new sap.ui.model.json.JSONModel();
oEntityContainerModel.setData(oMetaModelEntityContainer);
sap.ui.getCore().setModel(oEntityContainerModel, "entityContainer");

// set up models
var i18nModel = new sap.ui.model.resource.ResourceModel({
	bundleUrl : [ ".", "../i18n/messageBundle.properties" ].join("/")
});
sap.ui.getCore().setModel(i18nModel, "i18nModel");

var oQueryModel = new sap.ui.model.json.JSONModel();
oQueryModel.loadData("sparqlish.qunit.odata.json", null, false);
sap.ui.getCore().setModel(oQueryModel, "queryModel");

// datatypesModel>
var oDatatypesModel = new sap.ui.model.json.JSONModel();
oDatatypesModel.loadData("../config/test/datatypes.json", null, false);
sap.ui.getCore().setModel(oDatatypesModel, "datatypesModel");

// parametersModel>
var oParametersModel = new sap.ui.model.json.JSONModel();;
oParametersModel.setJSON('{"expandClause":true}', true);
sap.ui.getCore().setModel(oParametersModel, "parametersModel");

//lensesModel>
var oLensesModel = new sap.ui.model.json.JSONModel();
oLensesModel.loadData("../config/test/lenses.json", null, false);
sap.ui.getCore().setModel(oLensesModel, "lensesModel");

//queryModel>
var oQueryModel = new sap.ui.model.json.JSONModel();
oQueryModel.setData(
// 		{
// 	"_class": "Query",
// 	"concept": "Orders"}

//{"_class":"Query","concept":"Orders","clauses":{"_class":"Clauses","clause":{},"conjunctionClauses":[]}}

		{
	"_class": "Query",
	"concept": "Orders",
	"clauses": 
	{
		"_class": "Clauses",
		"clause": 
		{
			"_class": "Clause",
			"ignore": false,
			"optional": false,
			"propertyClause": 
			{
				"_class": "DataPropertyClause",
				"dataProperty": "OrderDate",
				"dataPropertyFilters": 
				{
					"_class": "DataPropertyFilters"
				}
			}
		},

		"conjunctionClauses": 
		[
			{
				"_class": "ConjunctionClause",
				"conjunction": "and",
				"clause": 
				{
					"_class": "Clause",
					"ignore": false,
					"optional": false,
					"propertyClause": 
					{
						"_class": "DataPropertyClause",
						"dataProperty": "RequiredDate",
						"dataPropertyFilters": 
						{
							"_class": "DataPropertyFilters"
						}
					}
				}
			}
		]
	}
}
		
// {
// 	"_class": "Query",
// 	"concept": "Orders",
// 	"clauses": 
// 	{
// 		"_class": "Clauses",
// 		"clause": 
// 		{
// 			"_class": "Clause",
// 			"ignore": false,
// 			"optional": false,
// 			"propertyClause": 
// 			{
// 				"_class": "DataPropertyClause",
// 				"dataProperty": "ShipName",
// 				"dataPropertyFilters": 
// 				{
// 					"_class": "DataPropertyFilters"
// 				}
// 			}
// 		},

// 		"conjunctionClauses": 
// 		[
// 			{
// 				"_class": "ConjunctionClause",
// 				"conjunction": "and",
// 				"clause": 
// 				{
// 					"_class": "Clause",
// 					"ignore": false,
// 					"optional": false,
// 					"propertyClause": 
// 					{
// 						"_class": "ObjectPropertyClause",
// 						"objectProperty": "Shipper",
// 						"objectPropertyFilters": 
// 						[
							
// 						],

// 						"clauses": 
// 						{
// 							"_class": "Clauses",
// 							"clause": 
// 							{
// 								"_class": "Clause",
// 								"ignore": false,
// 								"optional": false,
// 								"propertyClause": 
// 								{
// 									"_class": "DataPropertyClause",
// 									"dataProperty": "CompanyName",
// 									"dataPropertyFilters": 
// 									{
// 										"_class": "DataPropertyFilters"
// 									}
// 								}
// 							},

// 							"conjunctionClauses": 
// 							[
// 								{
// 									"_class": "ConjunctionClause",
// 									"conjunction": "and",
// 									"clause": 
// 									{
// 										"_class": "Clause",
// 										"ignore": false,
// 										"optional": false,
// 										"propertyClause": 
// 										{
// 											"_class": "ObjectPropertyClause",
// 											"objectProperty": "Orders",
// 											"objectPropertyFilters": 
// 											[
												
// 											],

// 											"clauses": 
// 											{
// 												"_class": "Clauses",
// 												"clause": 
// 												{
// 													"_class": "Clause",
// 													"ignore": false,
// 													"optional": false,
// 													"propertyClause": 
// 													{
// 														"_class": "DataPropertyClause",
// 														"dataProperty": "OrderDate",
// 														"dataPropertyFilters": 
// 														{
// 															"_class": "DataPropertyFilters"
// 														}
// 													}
// 												}
// 											}
// 										}
// 									}
// 								}
// 							]
// 						}
// 					}
// 				}
// 			}
// 		]
// 	}
// }
);
var oQuery = new sparqlish.control.query();
oQuery.setModel(oQueryModel, "queryModel");
oQuery.setModel(oMetaModel, "metaModel");
oQuery.setModel(oDatatypesModel, "datatypesModel");
oQuery.bindElement("queryModel>/");
oQuery.placeAt("uiQueryClauseInit");


// Create a table component

var oTableComponent = sap.ui.getCore().createComponent({
	name : "Components.queryResultsTable",
	settings : {
		title : "Hello World again",
		metaModel : oMetaModel
	}
});
var oTableComponentContainer = new sap.ui.core.ComponentContainer({
	component : oTableComponent
});

displayQueryResultsTable = function() {
	var query = new Query(oQueryModel.getData());
	var odataURL = sUrl + query.odataURI() + "&$format=json";
	oTableComponent.renderResults(odataURL);
};
//Place controls
oTableComponentContainer.placeAt("uiTablePanel");

// Create a form component

var oFormComponent = sap.ui.getCore().createComponent({
	name : "Components.queryResultsForm",
	settings : {
		title : "Hello World again",
		metaModel : oMetaModel
	}
});
var oFormComponentContainer = new sap.ui.core.ComponentContainer({
	component : oFormComponent
});

displayQueryResultsForm = function() {
	var query = new Query(oQueryModel.getData());
	var odataURL = sUrl + query.odataURI() + "&$format=json";
	oFormComponent.renderResults(odataURL);
};

//Place controls
oFormComponentContainer.placeAt("uiFormPanel");

var oLenses = oLensesModel.getData()["lenses"]["(default)"]["Northwind.Orders"];
var oContent = oLensesModel.getData()["templates"][ oLenses.template]; 
var oFragments = {
	"R3-C1" : oFormComponentContainer,
	"R1" : oTableComponentContainer
};



</script>
</head>
<body>
		<table border="1">		
				<tr>
						<td><button onclick="alert(JSON.stringify(oQueryModel.getData()))">QueryData</button></td>
						<td><button onclick="var query = new Query(oQueryModel.getData());alert(JSON.stringify(query.viewModel()))">ViewModel</button></td>
						<td><button onclick="var query = new Query(oQueryModel.getData());alert(query.sparql())">SPARQLQuery</button></td>
						<td><button onclick="var query = new Query(oQueryModel.getData());alert(sUrl + query.odataURI())">ODataQuery</button></td>
						<td><button onclick="var query = new Query(oQueryModel.getData());window.open(sUrl + query.odataURI()+'&$format=json')">ODataResult</button></td>
						<td><button onclick="displayQueryResultsTable()">ODataTabularDisplay</button></td>
						<td><button onclick="displayQueryResultsForm()">ODataFormDisplay</button></td>
						<td><div id="uiQueryClauseInit"></div></td>
				</tr>	
			</table>
		<div id="uiTablePanel"></div>
		<div id="uiFormPanel"></div>
</body>
</html>