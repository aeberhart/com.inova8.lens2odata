<!doctype html>
<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta http-equiv="Content-Type" content="text/html;charset=UTF-8" />
<!-- <base href="../"> -->
<title>QueryRows</title>
<script id="sap-ui-bootstrap" src="../openui5/sap-ui-core.js" data-sap-ui-theme="sap_bluecrystal" data-sap-ui-libs="sap.ui.commons"
		data-sap-ui-libs="sap.ui.unified" data-sap-ui-libs="sap.ui.table"
		data-sap-ui-resourceroots='{
            "sparqlish":"../",
					"sparqlish":"../sparqlish"
        }' data-sap-ui-xx-bindingSyntax="complex"
		type="text/javascript"></script>
<script type="text/javascript" src="../resources/jquery.rdfquery.core.min-1.0.js"></script>
<script type="text/javascript" src="../sparqlish/sparqlish.js"></script>
<script type="text/javascript" src="../sparqlish/utilities.js"></script>
<script type="text/javascript" src="../sparqlish/control/propertyMenu.js"></script>
<script type="text/javascript" src="../sparqlish/control/includeOptionalIgnore.js"></script>
<script type="text/javascript" src="../sparqlish/control/queryClause.js"></script>
<script type="text/javascript" src="../sparqlish/control/conceptClause.js"></script>
<script type="text/javascript" src="../sparqlish/control/propertyClause.js"></script>
<script type="text/javascript" src="../sparqlish/control/conjunctionPropertyClause.js"></script>
<script type="text/javascript" src="../sparqlish/control/query.js"></script>

<link rel="stylesheet" type="text/css" href="../sparqlish/sparqlish.css">
<script type="text/javascript">
var self =this;
self.iCurrentQuery =0;


/*
SPARQLish requires a  query model (queryModel>) from which it derives a viewModel (viewModel>)
To control the construction of the queryModel and hence the SPARQL or OData query the application also requires an OData metaModel (metamodel>). 
The metamodel can be derived from the OData model (dataModel>) which is delivered by the Odata server.
In the absence of an actual OData server we can create a 'mock' server by providing a suitable metadata
The final model is ResourceModel to support resource bundles used for language based labels (i18nModel>). 
In summary the models are:
	i18nModel>: the ResourceModel created using new sap.ui.model.resource.ResourceModel.
	dataModel>: the ODataModel provided by the ODataserver (or Mockserver) using new sap.ui.model.odata.ODataModel(sUri, true).
	metaModel>: the MetaModel that is provided by the OData using  oDataModel.getMetaModel().
	queryModel>: the JSONModel that conatins the 0, 1 or many queriues in SPARQLish format, created by loading the coirresponding queryModel file.
	viewModel>: The JSONModel derived from the queryModel so that it conatins the requisite indenting etc for displaying a particular query in a tree format. 
	datatypesModel>: The JSONModel containing the different conditions for differenbt datatypes.
*/
 jQuery.sap.log.setLevel(jQuery.sap.log.Level.DEBUG );
 
//Mock OData mock server
jQuery.sap.require("sap.ui.core.util.MockServer"); 
var sUri = "/mock/";
var oMockServer = new sap.ui.core.util.MockServer({
    rootUri : sUri
});
var sUrl = "../proxy/http/services.odata.org/V2/Northwind/Northwind.svc/" ;
//var sMetadataUrl = "test-resources/northwind.v2.metadata.xml"; 
//var sMetadataUrl = "test-resources/lenspoc.v2.metadata.xml"; 
var sMetadataUrl = "../config/test/northwind.v2.metadata.xml";
oMockServer.simulate(sMetadataUrl);
oMockServer.start();  

// set up models
// i18nModel>
var i18nModel = new sap.ui.model.resource.ResourceModel({
		bundleUrl : [ ".", "../i18n/messageBundle.properties" ].join("/")
});
sap.ui.getCore().setModel(i18nModel, "i18nModel");

// dataModel>
var oDataModel = new sap.ui.model.odata.ODataModel(sUri, true);
sap.ui.getCore().setModel(oDataModel, "dataModel");

// metaModel>
var oMetaModel = oDataModel.getMetaModel();
sap.ui.getCore().setModel(oMetaModel, "metaModel");

// queryModel>
var oQueriesModel = new sap.ui.model.json.JSONModel();
//oQueryModel.loadData("../config/test/query.test1.json", null, false);
oQueriesModel.loadData("../config/test/query.test9.json", null, false);
sap.ui.getCore().setModel(oQueriesModel, "queriesModel");

//viewModel>, not initialized until query chosen since it is specific to a single query
var oViewModel=new sap.ui.model.json.JSONModel();
sap.ui.getCore().setModel(oViewModel, "viewModel");

// datatypesModel>
var oDatatypesModel = new sap.ui.model.json.JSONModel();
oDatatypesModel.loadData("../config/test/datatypes.json", null, false);
sap.ui.getCore().setModel(oDatatypesModel, "datatypesModel");

// parametersModel>
var oParametersModel = new sap.ui.model.json.JSONModel();;
oParametersModel.setJSON('{"expandClause":false}', true);
sap.ui.getCore().setModel(oParametersModel, "parametersModel");

// TODO this should be part of the control
var oMetaModelEntityContainer = oMetaModel.getODataEntityContainer();
var oEntityContainerModel = new sap.ui.model.json.JSONModel();
oEntityContainerModel.setData(oMetaModelEntityContainer);
sap.ui.getCore().setModel(oEntityContainerModel, "entityContainer");

initRowRepeater =function(){
	if(!jQuery.isEmptyObject(self.oRowRepeater)) self.oRowRepeater.destroy;
	delete self.oRowRepeater;
self.oRowRepeater =  new sap.ui.commons.RowRepeater()

var oRowTemplate = new sap.ui.commons.layout.MatrixLayout();
oRowTemplate.setWidth("70%");
var matrixRow = new sap.ui.commons.layout.MatrixLayoutRow();

var control =    new sparqlish.control.queryClause(  {
				clausePath : {path: "viewModel>path"}//,
		//changedClause:refresh
		});
		
var matrixCell = new sap.ui.commons.layout.MatrixLayoutCell();
matrixCell.addContent(control);
matrixRow.addCell(matrixCell);

oRowTemplate.addRow(matrixRow);

oRowRepeater.setNumberOfRows(5);
// this.oTable.bindRows("viewModel>/");
// this.oTable.placeAt("uiTable");
self.oRowRepeater.setModel(oDataModel, "dataModel");
self.oRowRepeater.setModel(oMetaModel, "metaModel");
self.oRowRepeater.setModel(oQueriesModel, "queriesModel");
self.oRowRepeater.setModel(oViewModel, "viewModel");

return oRowTemplate;

}

//initTable();

// Query display table

var queryAST = oQueriesModel.getData();
var queries = new Queries(queryAST);


//Set models to table, just in case
 
// oTable.setModel(oDataModel, "dataModel");
// oTable.setModel(oMetaModel, "metaModel");
// oTable.setModel(oQueriesModel, "queriesModel");
//temporary should really set the query to a single queryModel not a set of queryModels
sap.ui.getCore().setModel(oQueriesModel, "queryModel");
//oTable.setModel(oQueriesModel, "queryModel");
var oQueryModel =oQueriesModel;

//oTable.setModel(oViewModel, "viewModel");

// Query list
var oComboBox = sap.ui.jsfragment("sparqlish.query.queryList", this);
oComboBox.placeAt("uiMenu");

// Review query action
var oShowButton =  new sap.ui.commons.Button({
			text : "Show query data",
			tooltip : "This show query",
			press : function() {
				alert(JSON.stringify(oQueriesModel.getData().queries[self.iCurrentQuery]));
			}});
oShowButton.placeAt("uiShowQuery");

// SPARQLQuery action
var oQueryButton = sap.ui.jsfragment("sparqlish.query.query", this);
oQueryButton.placeAt("uiSPARQLQuery");

// ODataQuery action
var oODataButton = sap.ui.jsfragment("sparqlish.query.odata", this);
oODataButton.placeAt("uiODataQuery");

// Preview action
var oButton = sap.ui.jsfragment("sparqlish.query.preview", this);
oButton.placeAt("uiPreview");

	try{
		self.oRowRepeater.destroyRows();
	}catch(e){
		
	}
	
	var oRowTemplate = initRowRepeater();	
querySelectionChange = function(iSelectedQuery) {


	self.oRowRepeater.placeAt("uiTable");
	self.oViewModel.setData(queries.oQueries[iSelectedQuery].oViewModel);
	self.oRowRepeater.setModel(oViewModel, "viewModel");
	self.oRowRepeater.bindRows("viewModel>/root", oRowTemplate);
}
</script>
</head>
<body>
		<table border="1">
				<tr>
						<td><div id="uiMenu">Select Query:</div></td>
						<td><div id="uiShowQuery"></div></td>
						<td><div id="uiSPARQLQuery"></div></td>
						<td><div id="uiODataQuery"></div></td>
						<td><button onclick="var query = new Query(oQueriesModel.getData().queries[self.iCurrentQuery]);window.open(sUrl + query.odataURI()+'&$format=json')">OData Query Results</button></td>
						<td><div id="uiPreview"></div></td>
				</tr>
		</table>
		<div id="uiTable"></div>
</body>
</html>